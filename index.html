<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoMail Ultra Premium - Global Identity System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800;900&display=swap');
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Plus Jakarta Sans', sans-serif;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle at top right, #1e3a8a, #000, #000);
        }

        .glass-capsule {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 9999px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px;
        }

        /* Toast UI Fix */
        #toast {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(-250%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 99999;
            opacity: 0;
        }
        #toast.active { 
            transform: translateX(-50%) translateY(0); 
            opacity: 1;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(15px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s ease; }

        .nav-active {
            background: linear-gradient(135deg, rgba(59,130,246,0.4), rgba(59,130,246,0.1));
            color: #60a5fa;
            border: 1px solid rgba(59,130,246,0.6);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: zoomIn 0.3s ease; }

        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Scanning Animation */
        .scan-container {
            position: relative;
            overflow: hidden;
        }
        .scan-line {
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            position: absolute;
            top: -10%;
            left: 0;
            animation: scanMove 2s linear infinite;
            box-shadow: 0 0 15px #3b82f6;
        }
        @keyframes scanMove {
            0% { top: -10%; }
            100% { top: 110%; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Red Dot Notification */
        .notification-dot {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 8px;
            height: 8px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 2px solid #000;
            display: none;
            box-shadow: 0 0 8px #ef4444;
        }
        .notification-dot.active { display: block; }

        /* Loader */
        .loading-spin { animation: spin 0.8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: rgba(255,255,255,0.1);
            transition: .4s;
            border-radius: 34px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #2563eb; border-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(20px); }

    </style>
</head>
<body class="flex flex-col">

    <div id="modal" class="modal-overlay">
        <div class="glass-card p-8 w-full max-w-xs text-center space-y-6 border-blue-500/50">
            <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto">
                <i data-lucide="alert-triangle" class="text-red-500 w-8 h-8"></i>
            </div>
            <div>
                <h3 class="text-lg font-bold">Are you sure?</h3>
                <p id="modal-desc" class="text-xs text-gray-400 mt-2">This action cannot be undone.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="glass-capsule flex-1 py-3 text-sm">Cancel</button>
                <button id="modal-confirm-btn" class="glass-capsule flex-1 py-3 text-sm bg-red-600/30 text-red-400 border-red-500/50 font-bold">Delete</button>
            </div>
        </div>
    </div>

    <div id="mail-reader" class="modal-overlay">
        <div class="glass-card p-6 w-full max-w-sm h-[80vh] flex flex-col border-blue-500/30">
            <div class="flex justify-between items-center mb-6">
                <span class="text-[10px] font-black text-blue-500 tracking-widest uppercase">Encrypted Mail</span>
                <button onclick="closeMailReader()" class="p-2 glass-capsule"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="space-y-4 flex-1 overflow-y-auto no-scrollbar">
                <div>
                    <p class="text-[9px] text-gray-500 uppercase font-bold">Subject</p>
                    <h2 id="read-subject" class="text-sm font-bold text-white"></h2>
                </div>
                <div>
                    <p class="text-[9px] text-gray-500 uppercase font-bold">From</p>
                    <p id="read-from" class="text-xs font-mono text-blue-400"></p>
                </div>
                <hr class="border-white/10">
                <div id="read-body" class="text-xs text-gray-300 leading-relaxed whitespace-pre-wrap"></div>
            </div>
            <button onclick="closeMailReader()" class="mt-6 glass-capsule py-4 w-full text-[10px] font-black bg-blue-600/20 border-blue-500/50">BACK TO INBOX</button>
        </div>
    </div>

    <div id="toast" class="glass-capsule px-6 py-2.5 flex items-center gap-3 border-blue-400/60 shadow-[0_0_30px_rgba(59,130,246,0.3)]">
        <i data-lucide="zap" class="w-4 h-4 text-blue-400"></i>
        <span id="toast-msg" class="text-[10px] font-black uppercase tracking-wider"></span>
    </div>

    <header class="p-8 flex justify-between items-end">
        <div>
            <p class="text-[10px] text-blue-500 font-black tracking-[0.3em] uppercase mb-1">Network Monitor: Active</p>
            <h1 class="text-3xl font-[900] tracking-tighter">NEO<span class="text-blue-500">MAIL</span></h1>
        </div>
        <div class="glass-capsule p-2 px-4 bg-white/5 border-white/20">
            <span class="text-[10px] font-bold text-green-400 flex items-center gap-2">
                <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                SYNCING EVERY 3S
            </span>
        </div>
    </header>

    <main class="flex-1 px-6 overflow-y-auto no-scrollbar pb-10">
        
        <section id="home" class="tab-content active space-y-6">
            <div class="grid grid-cols-2 gap-3">
                <div class="glass-card p-4 flex flex-col items-center justify-center border-white/20">
                    <span id="stat-total" class="text-xl font-black text-blue-400">0</span>
                    <span class="text-[8px] text-gray-500 uppercase font-bold">Total Nodes</span>
                </div>
                <div class="glass-card p-4 flex flex-col items-center justify-center border-white/20">
                    <span id="stat-inbox" class="text-xl font-black text-green-400">0</span>
                    <span class="text-[8px] text-gray-500 uppercase font-bold">Global Unread</span>
                </div>
            </div>

            <div class="glass-card p-8 text-center space-y-6 border-white/20 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="fingerprint" class="w-20 h-20"></i></div>
                <div class="space-y-2">
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Primary Virtual Identity</p>
                    <div id="email-box" class="text-lg font-mono text-blue-100 break-all p-5 bg-black/40 rounded-[2rem] border border-blue-500/40 shadow-inner">
                        Initializing...
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="copyEmail()" class="glass-capsule flex-1 py-4 flex items-center justify-center gap-2 active:scale-90 transition-all bg-white/5 border-white/20">
                        <i data-lucide="copy" class="w-4 h-4 text-blue-400"></i> <span class="text-xs font-bold">COPY</span>
                    </button>
                    <button id="btn-create" onclick="createNewEmail()" class="glass-capsule flex-1 py-4 flex items-center justify-center gap-2 bg-blue-600/20 border-blue-500/60 active:scale-90 transition-all">
                        <span id="create-icon"><i data-lucide="plus-circle" class="w-4 h-4 text-blue-400"></i></span>
                        <span class="text-xs font-bold">NEW NODE</span>
                    </button>
                </div>
            </div>

            <div class="space-y-3">
                <p class="text-[10px] text-gray-500 font-bold uppercase ml-2 tracking-widest">Global Protocol</p>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="switchTab('mailbox')" class="glass-card p-4 flex items-center justify-between hover:bg-white/5 transition border-white/20">
                        <div class="flex items-center gap-3">
                            <i data-lucide="layout-list" class="w-5 h-5 text-blue-500"></i>
                            <span class="text-sm font-semibold">Global Inbox View</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600"></i>
                    </button>
                    <button onclick="switchTab('settings')" class="glass-card p-4 flex items-center justify-between hover:bg-white/5 transition border-white/20">
                        <div class="flex items-center gap-3">
                            <i data-lucide="shield-check" class="w-5 h-5 text-purple-500"></i>
                            <span class="text-sm font-semibold">Security Settings</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600"></i>
                    </button>
                </div>
            </div>
        </section>

        <section id="mailbox" class="tab-content space-y-4">
            <h2 class="text-sm font-black uppercase tracking-widest text-gray-500 px-2">Global Signal Buffer</h2>
            <div id="inbox-list" class="space-y-3"></div>
        </section>

        <section id="history" class="tab-content space-y-4">
            <div class="flex justify-between items-center px-2">
                <h2 class="text-sm font-black uppercase tracking-widest text-gray-500">Identity Vault</h2>
                <button onclick="confirmClearAll()" class="text-red-500 text-[10px] font-black tracking-widest">WIPE ALL</button>
            </div>
            <div id="history-list" class="space-y-3"></div>
        </section>

        <section id="settings" class="tab-content space-y-6">
            <div class="glass-card p-6 space-y-4 border-white/20">
                <h3 class="text-[10px] font-black text-blue-500 uppercase tracking-[0.2em]">API Status Details</h3>
                <div class="space-y-3">
                    <div class="flex justify-between text-[11px]">
                        <span class="text-gray-400">Service</span>
                        <span class="text-white font-mono">MailSlurp Global</span>
                    </div>
                    <div class="flex justify-between text-[11px]">
                        <span class="text-gray-400">Refresh Rate</span>
                        <span class="text-green-500 font-bold uppercase">3 SECONDS</span>
                    </div>
                    <div class="flex justify-between text-[11px]">
                        <span class="text-gray-400">Inbox Mode</span>
                        <span class="text-blue-500 font-bold uppercase">MULTI-NODE SCAN</span>
                    </div>
                </div>
            </div>

            <div class="glass-card p-6 space-y-5 border-white/20">
                <h3 class="text-[10px] font-black text-blue-500 uppercase tracking-[0.2em]">Application Control</h3>
                
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm font-bold">Auto-Sync Signals</p>
                        <p class="text-[9px] text-gray-500">Real-time background scanning</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="sett-autocopy" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm font-bold text-red-400">Wipe System</p>
                        <p class="text-[9px] text-gray-500">Clear all identities and cache</p>
                    </div>
                    <button onclick="confirmClearAll()" class="p-2 bg-red-500/10 rounded-lg border border-red-500/30">
                        <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <div class="p-6">
        <nav class="glass-capsule p-2 flex justify-around items-center border-white/20 bg-black/50">
            <button onclick="switchTab('home')" id="btn-home" class="p-4 rounded-full nav-active transition-all"><i data-lucide="layout-grid" class="w-5 h-5"></i></button>
            <button onclick="switchTab('mailbox')" id="btn-mailbox" class="p-4 rounded-full transition-all relative">
                <i data-lucide="mail" class="w-5 h-5"></i>
                <span id="mail-dot" class="notification-dot"></span>
            </button>
            <button onclick="switchTab('history')" id="btn-history" class="p-4 rounded-full transition-all"><i data-lucide="history" class="w-5 h-5"></i></button>
            <button onclick="switchTab('settings')" id="btn-settings" class="p-4 rounded-full transition-all"><i data-lucide="sliders" class="w-5 h-5"></i></button>
        </nav>
    </div>

    <script>
        const API_KEY = "sk_mMkCkMUCJC40cDCg_pLkEdoyAY1cKFpiQa8M1Ef0k1BnMInEkRucZoBFootOey35wfgIinM5VzJM2yPax";
        const BASE_URL = "https://api.mailslurp.com";
        
        let state = {
            currentInboxId: localStorage.getItem('current_inbox_id') || "",
            currentEmail: localStorage.getItem('current_email') || "",
            history: JSON.parse(localStorage.getItem('mail_history_v3')) || [],
            messages: [],
            readMessages: JSON.parse(localStorage.getItem('read_messages_v3')) || [],
        };

        lucide.createIcons();

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 2500);
        }

        let modalCallback = null;
        function openModal(desc, callback) {
            document.getElementById('modal-desc').innerText = desc;
            document.getElementById('modal').classList.add('active');
            modalCallback = callback;
        }
        function closeModal() { document.getElementById('modal').classList.remove('active'); }
        document.getElementById('modal-confirm-btn').onclick = () => {
            if(modalCallback) modalCallback();
            closeModal();
        };

        async function openMailReader(id) {
            const msg = state.messages.find(m => m.id === id);
            if(!msg) return;

            document.getElementById('read-subject').innerText = msg.subject || 'No Subject';
            document.getElementById('read-from').innerText = msg.from || 'Unknown Sender';
            document.getElementById('read-body').innerText = "Decrypting global signal...";
            document.getElementById('mail-reader').classList.add('active');

            if(!state.readMessages.includes(id)) {
                state.readMessages.push(id);
                localStorage.setItem('read_messages_v3', JSON.stringify(state.readMessages));
                updateNotificationDot();
                renderInbox(); 
            }

            try {
                const response = await fetch(`${BASE_URL}/emails/${id}`, { headers: { 'x-api-key': API_KEY } });
                const data = await response.json();
                document.getElementById('read-body').innerText = data.body || "No message content found.";
            } catch (e) {
                document.getElementById('read-body').innerText = "Error: Could not retrieve encrypted body.";
            }
        }

        function closeMailReader() { document.getElementById('mail-reader').classList.remove('active'); }

        async function createNewEmail() {
            const btn = document.getElementById('btn-create');
            const icon = document.getElementById('create-icon');
            btn.disabled = true;
            icon.classList.add('loading-spin');

            try {
                // FIXED: Adding proper headers and empty JSON body for better API compatibility
                const response = await fetch(`${BASE_URL}/inboxes`, {
                    method: 'POST',
                    headers: { 
                        'x-api-key': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({}) 
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();

                state.currentInboxId = data.id;
                state.currentEmail = data.emailAddress;
                state.history.unshift({ id: data.id, email: data.emailAddress });
                
                localStorage.setItem('current_inbox_id', state.currentInboxId);
                localStorage.setItem('current_email', state.currentEmail);
                localStorage.setItem('mail_history_v3', JSON.stringify(state.history));

                updateHomeUI();
                showToast("New Node Active");
                fetchAllMessages();
            } catch (error) {
                console.error(error);
                showToast("Creation Failed");
            } finally {
                btn.disabled = false;
                icon.classList.remove('loading-spin');
            }
        }

        async function fetchAllMessages() {
            // Include both current and all history IDs for a global scan
            let allInboxIds = state.history.map(h => h.id);
            if (state.currentInboxId && !allInboxIds.includes(state.currentInboxId)) {
                allInboxIds.push(state.currentInboxId);
            }

            if (allInboxIds.length === 0) return;

            try {
                // Fetch from all IDs in parallel
                const fetchPromises = allInboxIds.map(id =>
                    fetch(`${BASE_URL}/inboxes/${id}/emails`, { 
                        headers: { 'x-api-key': API_KEY } 
                    }).then(res => res.json())
                );

                const results = await Promise.all(fetchPromises);
                let combinedMessages = results.flat();

                // Sort newest first
                combinedMessages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                state.messages = combinedMessages;
                updateNotificationDot();
                updateHomeUI();
                
                if (document.getElementById('mailbox').classList.contains('active')) {
                    renderInbox();
                }
            } catch (error) { 
                console.error("Sync Failure:", error); 
            }
        }

        function updateNotificationDot() {
            const unreadCount = state.messages.filter(m => !state.readMessages.includes(m.id)).length;
            const dot = document.getElementById('mail-dot');
            if (unreadCount > 0) dot.classList.add('active');
            else dot.classList.remove('active');
            document.getElementById('stat-inbox').innerText = unreadCount;
        }

        function updateHomeUI() {
            document.getElementById('email-box').innerText = state.currentEmail || "No Identity Syncing...";
            document.getElementById('stat-total').innerText = state.history.length;
        }

        function copyEmail() {
            if(!state.currentEmail) return;
            navigator.clipboard.writeText(state.currentEmail);
            showToast("Address Copied");
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
            document.getElementById(tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('nav-active');
            
            if(tabId === 'mailbox') renderInbox();
            if(tabId === 'history') renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('history-list');
            if(state.history.length === 0) {
                container.innerHTML = `<div class="glass-card p-10 text-center opacity-20 text-xs uppercase tracking-widest">Vault Empty</div>`;
                return;
            }
            container.innerHTML = state.history.map((item, index) => `
                <div class="glass-card p-4 flex justify-between items-center border-white/20">
                    <div onclick="activateIdentity('${item.id}', '${item.email}')" class="flex-1 cursor-pointer">
                        <p class="text-[10px] font-mono font-bold ${item.id === state.currentInboxId ? 'text-blue-400' : 'text-gray-400'}">${item.email}</p>
                    </div>
                    <button onclick="confirmDeleteOne(${index})" class="p-2 text-red-500/30 hover:text-red-500 transition-colors">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderInbox() {
            const container = document.getElementById('inbox-list');
            if(state.messages.length === 0) {
                container.innerHTML = `
                    <div class="glass-card p-12 text-center border-dashed border-white/20 scan-container">
                        <div class="scan-line"></div>
                        <i data-lucide="satellite-dish" class="w-8 h-8 mx-auto mb-3 opacity-20"></i>
                        <p class="text-[10px] font-black opacity-30 tracking-widest uppercase">Global identity scan in progress...</p>
                    </div>`;
                lucide.createIcons();
                return;
            }
            container.innerHTML = state.messages.map(msg => {
                const isRead = state.readMessages.includes(msg.id);
                const targetNode = state.history.find(h => h.id === msg.inboxId) || { email: 'Active' };

                return `
                <div onclick="openMailReader('${msg.id}')" class="glass-card p-4 space-y-2 border-l-4 ${isRead ? 'border-white/10 opacity-70' : 'border-blue-500 bg-blue-500/5'} active:scale-95 transition-all cursor-pointer">
                    <div class="flex justify-between items-start">
                        <span class="text-[9px] font-black ${isRead ? 'text-gray-500' : 'text-blue-500'} uppercase">
                            ${isRead ? 'SIGNAL LOGGED' : 'INBOUND SIGNAL'}
                        </span>
                        <span class="text-[8px] text-gray-500">${new Date(msg.createdAt).toLocaleTimeString()}</span>
                    </div>
                    <p class="text-xs font-bold text-white truncate">${msg.subject || 'No Subject'}</p>
                    <div class="flex items-center gap-1.5 opacity-40">
                         <i data-lucide="cpu" class="w-2.5 h-2.5"></i>
                         <p class="text-[7px] font-mono truncate uppercase tracking-tighter">${targetNode.email}</p>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        function activateIdentity(id, email) {
            state.currentInboxId = id;
            state.currentEmail = email;
            localStorage.setItem('current_inbox_id', id);
            localStorage.setItem('current_email', email);
            updateHomeUI();
            switchTab('home');
            showToast("Identity Focused");
            fetchAllMessages();
        }

        function confirmDeleteOne(index) {
            openModal("Purge this node?", () => {
                state.history.splice(index, 1);
                localStorage.setItem('mail_history_v3', JSON.stringify(state.history));
                renderHistory();
                showToast("Node Removed");
                fetchAllMessages();
            });
        }

        function confirmClearAll() {
            openModal("Format system memory?", () => {
                localStorage.clear();
                location.reload();
            });
        }

        window.onload = () => {
            updateHomeUI();
            fetchAllMessages();
            // Global Refresh: Scans all nodes every 3 seconds
            setInterval(() => { 
                if(document.getElementById('sett-autocopy').checked) {
                    fetchAllMessages(); 
                }
            }, 3000);
        };
    </script>
</body>
</html>

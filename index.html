<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MultiMail Native</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg: #000000;
            --card-bg: #111111;
            --primary: #ff3b30; /* App Red */
            --text-main: #ffffff;
            --text-muted: #8e8e93;
            --border: #2c2c2e;
            --toast-bg: #1c1c1e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- APP HEADER --- */
        .app-header {
            padding: 15px 20px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed; top: 0; width: 100%; z-index: 50;
        }
        .header-title { font-size: 1.2rem; font-weight: 800; letter-spacing: -0.5px; }
        .header-title span { color: var(--primary); }
        .status-badge { font-size: 0.7rem; font-weight: 600; padding: 4px 10px; border-radius: 20px; background: #222; color: #666; }
        .status-badge.online { background: rgba(0,255,136,0.1); color: #00ff88; }

        /* --- MAIN CONTENT AREA --- */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 80px 20px 100px 20px; /* Space for Header & Nav */
        }

        /* --- SECTIONS (TABS) --- */
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARD STYLES --- */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .email-display {
            font-size: 1.1rem; font-weight: 600; color: var(--text-main);
            margin: 20px 0; word-break: break-all; font-family: monospace;
        }

        .btn-row { display: flex; gap: 10px; justify-content: center; }
        
        .app-btn {
            background: var(--card-bg); border: 1px solid var(--border);
            color: var(--text-main); padding: 12px 20px; border-radius: 12px;
            font-weight: 600; font-size: 0.9rem; flex: 1; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }
        .app-btn:active { transform: scale(0.96); background: #222; }
        .app-btn.primary { background: var(--primary); color: #fff; border: none; }
        
        /* --- MODE TOGGLE --- */
        .segmented-control {
            background: #222; padding: 4px; border-radius: 10px; display: flex; margin-bottom: 20px;
        }
        .segment-btn {
            flex: 1; padding: 8px; border: none; background: transparent; color: #888;
            font-weight: 600; font-size: 0.8rem; border-radius: 8px; transition: 0.2s;
        }
        .segment-btn.active { background: #444; color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        /* --- INBOX UI --- */
        .inbox-list { margin-top: 20px; }
        .inbox-item {
            background: var(--card-bg); padding: 15px; border-radius: 12px;
            border: 1px solid var(--border); margin-bottom: 10px;
            display: flex; flex-direction: column; gap: 5px;
        }
        .inbox-sender { font-weight: 700; font-size: 0.9rem; color: var(--primary); }
        .inbox-snippet { font-size: 0.85rem; color: #ccc; line-height: 1.4; }
        .empty-state { text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-top: 30px; }
        .empty-state i { font-size: 2rem; margin-bottom: 10px; display: block; opacity: 0.5; }

        /* --- HISTORY UI --- */
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border-bottom: 1px solid var(--border);
        }
        .history-email { font-size: 0.9rem; color: #fff; }
        .history-copy { color: var(--primary); padding: 5px 10px; font-size: 0.8rem; font-weight: 700; }

        /* --- BOTTOM NAVIGATION --- */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(10,10,10,0.9); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            padding: 10px 0 20px 0; /* Extra padding for iPhone home bar */
            z-index: 50;
        }
        .nav-item {
            text-align: center; color: var(--text-muted); font-size: 0.7rem;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            padding: 10px; width: 33%; cursor: pointer;
        }
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        /* --- CUSTOM TOAST/ALERT --- */
        #custom-toast {
            position: fixed; top: 70px; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: var(--toast-bg); color: #fff; padding: 12px 24px; border-radius: 50px;
            font-size: 0.9rem; font-weight: 600; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            border: 1px solid var(--border); opacity: 0; pointer-events: none; transition: 0.3s;
            z-index: 100; display: flex; align-items: center; gap: 10px;
        }
        #custom-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #custom-toast.error { border-color: var(--primary); color: var(--primary); }

        /* --- AUTH OVERLAY --- */
        #auth-overlay {
            position: fixed; inset: 0; background: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .auth-logo { font-size: 3rem; font-weight: 900; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="custom-toast"><i class="fas fa-info-circle"></i> <span id="toast-msg">Alert</span></div>

    <div id="auth-overlay">
        <div class="auth-logo">MULTI<span style="color:var(--primary)">MAIL</span></div>
        <p style="color:#666; margin-bottom:30px;">Professional Alias Tool</p>
        <button class="app-btn primary" style="width: auto; padding: 15px 40px;" onclick="handleAuth()">
            <i class="fab fa-google"></i> Login with Gmail
        </button>
    </div>

    <header class="app-header">
        <div class="header-title">Multi<span>Mail</span></div>
        <div class="status-badge" id="status-badge">OFFLINE</div>
    </header>

    <div class="content-area">
        
        <div id="tab-home" class="section active">
            <div class="card">
                <div class="segmented-control">
                    <button class="segment-btn active" id="seg-dot" onclick="toggleMode('dot')">Dot Mode</button>
                    <button class="segment-btn" id="seg-plus" onclick="toggleMode('plus')">Plus Mode</button>
                </div>

                <div style="font-size:0.7rem; color:#666; text-transform:uppercase; letter-spacing:1px; margin-top:10px;">Your Temporary Email</div>
                <div class="email-display" id="email-display">Tap Generate</div>

                <div class="btn-row">
                    <button class="app-btn" onclick="generateAlias()"><i class="fas fa-sync-alt"></i> Generate</button>
                    <button class="app-btn primary" onclick="copyEmail()"><i class="fas fa-copy"></i> Copy</button>
                </div>
                
                <div id="tag-input-box" style="margin-top:15px; display:none;">
                    <input type="text" id="custom-tag" placeholder="Enter Tag (e.g. pubg)" style="width:100%; background:#222; border:none; padding:10px; color:#fff; border-radius:8px; text-align:center;">
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding: 0 5px;">
                <h3 style="font-size:1rem;">Inbox</h3>
                <button onclick="fetchOTP()" style="background:transparent; border:none; color:var(--primary); font-weight:600; font-size:0.8rem;">REFRESH</button>
            </div>
            
            <div class="inbox-list" id="inbox-list">
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    No emails yet. Check for new messages.
                </div>
            </div>
        </div>

        <div id="tab-scan" class="section">
            <h2 style="margin-bottom:20px;">Deep Scan</h2>
            <div class="card">
                <input type="text" id="scan-query" value="from:Instagram" style="width:100%; background:#222; border:1px solid #333; padding:15px; color:#fff; border-radius:10px; margin-bottom:15px;" placeholder="Search Query...">
                <button class="app-btn primary" style="width:100%;" onclick="fetchOTP(true)">Start Scan</button>
            </div>
            <div id="scan-results" class="inbox-list"></div>
        </div>

        <div id="tab-history" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>History</h2>
                <button onclick="clearHistory()" style="background:#222; color:var(--primary); border:none; padding:8px 15px; border-radius:8px; font-weight:700; font-size:0.8rem;">DELETE ALL</button>
            </div>
            <div id="history-list">
                </div>
        </div>

    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home', this)">
            <i class="fas fa-envelope"></i>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="switchTab('scan', this)">
            <i class="fas fa-search"></i>
            <span>Scanner</span>
        </div>
        <div class="nav-item" onclick="switchTab('history', this)">
            <i class="fas fa-history"></i>
            <span>History</span>
        </div>
    </nav>

    <script>
        // --- CONFIG ---
        const CLIENT_ID = '327243505568-tp9gl9v9ifvdab55q2djb74vn3f1ht9j.apps.googleusercontent.com';
        
        let tokenClient, accessToken;
        let currentMode = 'dot';
        let usedAliases = JSON.parse(localStorage.getItem('mm_history')) || [];

        // --- AUTH ---
        window.onload = () => {
            renderHistory();
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: 'https://www.googleapis.com/auth/gmail.readonly',
                callback: (r) => { accessToken = r.access_token; if(accessToken) fetchProfile(); }
            });
        };

        function handleAuth() { tokenClient.requestAccessToken(); }

        async function fetchProfile() {
            try {
                const r = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/profile', {headers: {'Authorization': `Bearer ${accessToken}`}});
                const d = await r.json();
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('status-badge').innerText = "ONLINE";
                document.getElementById('status-badge').classList.add('online');
                window.userEmail = d.emailAddress;
                showToast("Connected: " + d.emailAddress);
            } catch(e) { showToast("Login Failed", true); }
        }

        // --- UI LOGIC ---
        function switchTab(tabId, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        function toggleMode(mode) {
            currentMode = mode;
            document.getElementById('seg-dot').classList.toggle('active', mode === 'dot');
            document.getElementById('seg-plus').classList.toggle('active', mode === 'plus');
            document.getElementById('tag-input-box').style.display = mode === 'plus' ? 'block' : 'none';
        }

        function showToast(msg, isError = false) {
            const t = document.getElementById('custom-toast');
            document.getElementById('toast-msg').innerText = msg;
            t.className = isError ? 'error show' : 'show';
            setTimeout(() => t.className = t.className.replace('show', ''), 3000);
        }

        // --- CORE FUNCTIONS ---
        function generateAlias() {
            if(!window.userEmail) return showToast("Login Required!", true);
            const [u, d] = window.userEmail.split('@');
            let alias;
            
            if(currentMode === 'plus') {
                const tag = document.getElementById('custom-tag').value || Math.random().toString(36).substr(2,5).toUpperCase();
                alias = `${u}+${tag.replace(/\s/g,'')}@${d}`;
            } else {
                alias = applyDots(u) + "@" + d;
            }

            document.getElementById('email-display').innerText = alias;
            saveHistory(alias);
        }

        function applyDots(s) {
            let r = "";
            for(let i=0; i<s.length; i++) {
                r += s[i];
                if(i < s.length-1 && Math.random() > 0.5) r += ".";
            }
            return r === s ? applyDots(s) : r;
        }

        function copyEmail() {
            const txt = document.getElementById('email-display').innerText;
            if(txt === "Tap Generate") return;
            navigator.clipboard.writeText(txt);
            showToast("Copied to clipboard");
        }

        async function fetchOTP(isScanTab = false) {
            if(!accessToken) return showToast("Not Connected", true);
            const query = isScanTab ? document.getElementById('scan-query').value : "from:Instagram";
            const container = isScanTab ? document.getElementById('scan-results') : document.getElementById('inbox-list');
            
            if(!isScanTab) showToast("Refreshing Inbox...");

            try {
                const l = await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages?q=${query}&maxResults=5`, {headers:{'Authorization':`Bearer ${accessToken}`}});
                const d = await l.json();
                
                container.innerHTML = ""; // Clear list

                if(d.messages && d.messages.length) {
                    for(const msg of d.messages) {
                        const m = await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${msg.id}`, {headers:{'Authorization':`Bearer ${accessToken}`}});
                        const md = await m.json();
                        
                        // Extract Headers
                        const subject = md.payload.headers.find(h => h.name === 'Subject')?.value || "No Subject";
                        const from = md.payload.headers.find(h => h.name === 'From')?.value || "Unknown";

                        const div = document.createElement('div');
                        div.className = 'inbox-item';
                        div.innerHTML = `<div class="inbox-sender">${from.split('<')[0]}</div><div class="inbox-snippet">${md.snippet}</div>`;
                        container.appendChild(div);
                    }
                } else {
                    container.innerHTML = `<div class="empty-state"><i class="fas fa-search"></i>No emails found for query.</div>`;
                }
            } catch(e) { showToast("Error fetching emails", true); }
        }

        // --- HISTORY ---
        function saveHistory(a) { usedAliases.unshift(a); localStorage.setItem('mm_history', JSON.stringify(usedAliases)); renderHistory(); }
        
        function renderHistory() {
            const l = document.getElementById('history-list'); l.innerHTML = "";
            usedAliases.forEach(x => {
                const div = document.createElement('div'); div.className = 'history-item';
                div.innerHTML = `<span class="history-email">${x.length > 25 ? x.substr(0,22)+'...' : x}</span> <span class="history-copy" onclick="navigator.clipboard.writeText('${x}'); showToast('Copied')">COPY</span>`;
                l.appendChild(div);
            });
        }
        
        function clearHistory() { 
            if(confirm("Delete all history?")) { 
                usedAliases=[]; localStorage.removeItem('mm_history'); renderHistory(); 
                showToast("History Deleted");
            } 
        }
    </script>
</body>
</html>
